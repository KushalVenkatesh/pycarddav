#!/usr/bin/env python
# vim: set ts=4 sw=4 expandtab sts=4:
# ----------------------------------------------------------------------------
# "THE BEER-WARE LICENSE" (Revision 42):
# <geier@lostpackets.de> wrote this file. As long as you retain this notice you
# can do whatever you want with this stuff. If we meet some day, and you think
# this stuff is worth it, you can buy me a beer in return Christian Geier
# ----------------------------------------------------------------------------

"""
utility for querying the database
"""

import sys
import signal
from os import path
import argparse
from ConfigParser import SafeConfigParser

try:
    import sqlite3
except ImportError:
    print "pysqlite3 not installed"
    sys.exit(1)


#encoding = 'utf-8'
#errors = 'strict'



class PcQuery:
    """Querying the addressbook database"""
    def __init__(self, db_path = "~/.pycacard/abook.db",
                 encoding = "utf-8", errors = "strict", debug = False):
        self.db_path = path.expanduser(db_path)
        self.encoding = encoding
        self.errors = errors
        self.debug = debug
        self.display_all = False

    def set_encoding(self, encoding, errors = "strict"):
        """does what it says"""
        self.encoding = encoding
        self.errors = errors

    def set_db_path(self, db_path):
        """does what it says"""
        self.db_path = path.expanduser(db_path)

    def set_search_string(self, search_string):
        """does what it says"""
        self.search_string = search_string.decode(self.encoding, self.errors)

    def set_print_function(self, print_function):
        """does what it says"""
        self.print_function = print_function

    def set_display_all(self, display_all):
        """does what it says"""
        self.display_all = display_all

    def search(self):
        """does what it says"""
        contact_ids = self.get_contact_id_from_string()
        for contact_id in contact_ids:
            if self.print_function == "print_email":
                self.print_email(contact_id[0], True, 1)
            else:
                self.print_contact_info(contact_id[0], self.display_all, 1)

    def unknownError(self, string):
        """does what it says"""
        s = "An unknown Error occured"
        if self.debug == True:
            s += ": " + str(string)
        print s
        sys.exit(5)

    def set_debug(self, debug):
        """does what it says"""
        self.debug = debug

    def search_for(self, search_string):
        """does what it says"""
        conn = sqlite3.connect(self.db_path)
        c = conn.cursor()
        t = ('%'+ search_string +'%',)
        
        # look for matches in address table
        c.execute('SELECT * FROM email WHERE address LIKE (?);', t)
        result = c.fetchall()
        result_list = list()
        for i in result:
            t = (i[3], )
            c.execute('SELECT name FROM vcardtable WHERE href=(?);', t)
            name = c.fetchall()
            result_list.append((i[0], name[0][0], i[1]))
       
        # look for matches in names in vcardtable 
        t = ('%'+ search_string +'%',)
        c.execute('SELECT * FROM vcardtable WHERE name LIKE (?);', t)
        result = c.fetchall()
        for i in result:
            name = i[2]
            t = (i[0],)
            c.execute('SELECT * FROM email WHERE href=(?);', t)
            email_list = c.fetchall()
            for email_line in email_list:
                # email = email_line[0]
                # type = email_line[1]
                # pref = email_line[2]
                # href = email_line[3]
                result_list.append((email_line[0], name, email_line[1]))
        result_list = list(set(result_list)) # eliminate duplicates
        # sorting by name:
        result_list = sorted(result_list, key = lambda result: result[1])
        for i in result_list:
            print unicode(i[0] + u"\t" + i[1] + u"\t" + i[2]).encode(
                    "utf-8", "strict")
        conn.commit()
        c.close()


    def get_contact_id_from_string(self):
        """does what it says"""
        conn = sqlite3.connect(self.db_path)
        c = conn.cursor()
        t = ('%'+ self.search_string +'%',)
        c.execute('SELECT href FROM properties WHERE value LIKE (?)', t)
        result = c.fetchall()
        result = list(set(result))
        return result

    def print_contact_info(self, v_ref, display_all, more_than_one):
        """this is a more or less a clone of vobjects prettyPrint()"""
        conn = sqlite3.connect(self.db_path)
        c = conn.cursor()
        t = (v_ref,)
        c.execute('SELECT * FROM properties WHERE href=(?)', t)
        result = c.fetchall()
        card = dict()
        for i in result:
            if not card.has_key(i[1]):
                card[i[1]] = list()
            t = (i[0],)
            c.execute('SELECT parameter,value FROM parameters WHERE '
            'property_id=(?)', t )
            parameters = c.fetchall()
            parameter_string = str()
            if not parameters == list():
                for parameter in parameters:
                    if parameter[0] == "TYPE":
                        if not parameter_string == str():
                            parameter_string += ", "
                        parameter_string += parameter[1]
            card[i[1]].append((i[2], parameter_string))
        print "Name: " + card["FN"][0][0]
        del(card["FN"])
        for parameter_list in ("EMAIL","TEL"):
            if card.has_key(parameter_list):
                for parameter in card[parameter_list]:
                    s = ""
                    s += parameter_list.title()

                    if not parameter[1] == list():
                        s += " ("
                        s += parameter[1].title()
                        s += ")"
                    s += ": " +  parameter[0]
                    print s
                del(card[parameter_list])
        if display_all == True:
            for param_type in card:
                s = ""
                s += param_type
                if not card[param_type][0][1] == str():
                    s += " (" + card[param_type][0][1] + ")"
                s += ": "
                s += card[param_type][0][0]
                print s
        if more_than_one:
            print "\n"

        c.close()

    def print_email(self, v_ref, ignore, ignore1):
        """maimed print contact info"""
        conn = sqlite3.connect(self.db_path)
        c = conn.cursor()
        t = (v_ref,)
        c.execute('SELECT * FROM properties WHERE href=(?)', t)
        result = c.fetchall()
        card = dict()
        for i in result:
            if not card.has_key(i[1]):
                card[i[1]] = list()
            t = (i[0],)
            c.execute('SELECT parameter,value FROM parameters WHERE '
                      'property_id=(?)', t)
            parameters = c.fetchall()
            parameter_string = str()
            if not parameters == list():
                for parameter in parameters:
                    if parameter[0] == "TYPE":
                        if not parameter_string == str():
                            parameter_string += ", "
                        parameter_string += parameter[1]
            card[i[1]].append((i[2], parameter_string))
        name = card["FN"][0][0]
        del(card["FN"])
        for parameter_list in ("EMAIL",):
            if card.has_key(parameter_list):
                for parameter in card[parameter_list]:
                    s = name + " "

                    if not parameter[1] == list():
                        s += " ("
                        types = parameter[1].title()
                        s += ")"
                    email = parameter[0]
                    print email + "\t" + name +"\t(" + types + ")"
                del(card[parameter_list])
        c.close()



def signal_handler(signal, frame):
    """does what it says"""
    sys.exit(0)


# MAIN
def main(argv):
    """main function, it starts all here"""
    configfile = "~/.pycard/pycard.conf"

    parser = argparse.ArgumentParser(
        description = 'prints contacts cards matching a search string')
    parser.add_argument(
        "-c", "--config", action = "store", dest = "configfile",
        default = "~/.pycard/pycard.conf",
        help="defaults to ~/.pycard/pycard.conf")
    parser.add_argument("-v", "--version", action = "version", version = "0.3")
    parser.add_argument("-a", action = "store_true", dest = "display_all",
            default = "False", help = "prints the whole card, not only name, "
            "telephone numbers and email addresses")
    parser.add_argument("-m", dest = "print_function", action = "store_const",
            const = "print_email", default = "print_contact_info",
            help = "only prints email addresses, in a mutt friendly format")
    parser.add_argument("--debug", action = "store_true", dest = "debug",
            default = "False", help = "enable debugging")
    parser.add_argument("search_string", metavar = "SEARCHSTRING",
            help = "the string to search for")
    args = parser.parse_args()

    # let's try to hide some ugly python code, at least when hitting Ctrl-C
    signal.signal(signal.SIGINT, signal_handler)
    configfile = path.expanduser(args.configfile)

    parser = SafeConfigParser()
    parser.read(configfile)
    db_path = path.expanduser(parser.get('default', 'db_path'))

    print "searching for ", args.search_string, "..."

    my_query = PcQuery()
    my_query.set_encoding("utf-8", "strict")
    my_query.set_db_path(db_path)
    my_query.set_search_string(args.search_string)
    my_query.set_debug(args.debug)
    my_query.set_print_function(args.print_function)
    my_query.set_display_all(args.display_all)

    my_query.search()


    return 0

if __name__ == "__main__":
    main(sys.argv[1:0])
